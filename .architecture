# PADR√ïES DE ARQUITETURA DO PROJETO
# Este arquivo define os padr√µes obrigat√≥rios do projeto MinimalMarketing

## ‚ùå PROIBI√á√ïES ABSOLUTAS

### ARQUIVOS MARKDOWN
- N√ÉO CRIAR arquivos .md al√©m do README.md
- N√ÉO CRIAR CHANGELOGs, GUIAs, DOCs em Markdown
- N√ÉO CRIAR arquivos de documenta√ß√£o espalhados pelo projeto
- Documenta√ß√£o vai em coment√°rios no c√≥digo ou no README.md

### C√ìDIGO
- N√ÉO usar console.log para debug em produ√ß√£o
- N√ÉO commitar credenciais ou secrets
- N√ÉO criar fun√ß√µes com mais de 50 linhas (refatorar)
- N√ÉO deixar c√≥digo comentado (deletar)

---

## ‚úÖ PADR√ïES OBRIGAT√ìRIOS

### 1. ESTRUTURA DE DIRET√ìRIOS

```
/app
  /(public)      # Rotas p√∫blicas (sem autentica√ß√£o)
  /(auth)        # Rotas autenticadas (com valida√ß√£o)
  /api           # API routes (RESTful)
  /actions       # Server Actions (formul√°rios, mutations)

/lib
  - auth.ts      # Autentica√ß√£o e JWT
  - db.ts        # Conex√£o com banco
  - utils.ts     # Utilit√°rios gerais
  - access-control.ts     # Valida√ß√£o de acesso
  - api-middleware.ts     # Middleware de APIs
  - discount-helpers.ts   # L√≥gica de descontos

/contexts
  - AuthContext.tsx       # Context de autentica√ß√£o
  - CartContext.tsx       # Context de carrinho
  - DiscountContext.tsx   # Context de descontos

/components
  /ui            # Componentes reutiliz√°veis (Button, Card, etc)
  /layout        # Layout (Header, Footer, Container)

/drizzle
  - schema.ts    # Schema do banco de dados

/scripts
  - Scripts utilit√°rios (setup, deploy, etc)
```

### 2. SEGURAN√áA (CR√çTICO)

#### Autentica√ß√£o e Autoriza√ß√£o
- SEMPRE validar sess√£o JWT em APIs protegidas
- NUNCA confiar em dados do cliente (validar server-side)
- SEMPRE usar `requireAuth()` antes de opera√ß√µes sens√≠veis
- NUNCA aceitar userId da query/body (usar sess√£o)

#### Valida√ß√£o de Acesso
- SEMPRE validar acesso a produtos via `verifyUserProductAccess()`
- SEMPRE verificar `isActive === true` E `expiryDate > now`
- SEMPRE usar princ√≠pio fail-safe (negar se d√∫vida)
- SEMPRE implementar defense in depth (m√∫ltiplas camadas)

#### APIs Protegidas
```typescript
// Padr√£o obrigat√≥rio para APIs protegidas:
export async function GET(req: NextRequest) {
  // 1. VALIDAR AUTENTICA√á√ÉO
  const auth = await requireAuth(req);
  if (auth instanceof NextResponse) return auth;

  // 2. VALIDAR ACESSO (se necess√°rio)
  const access = await verifyUserProductAccess(userId, productId);
  if (!access.hasAccess) return forbidden();

  // 3. EXECUTAR L√ìGICA
  // ...

  // 4. RETORNAR RESPOSTA
  return NextResponse.json(data);
}
```

#### C√≥digos HTTP Corretos
- 200: Sucesso
- 201: Criado com sucesso
- 400: Bad Request (par√¢metros inv√°lidos)
- 401: Unauthorized (n√£o autenticado)
- 403: Forbidden (autenticado mas sem permiss√£o)
- 404: Not Found (recurso n√£o existe)
- 500: Internal Server Error (erro do servidor)

### 3. BANCO DE DADOS

#### Schema com Drizzle ORM
- SEMPRE usar Drizzle ORM (nunca SQL raw)
- SEMPRE definir rela√ß√µes no schema
- SEMPRE usar transactions para opera√ß√µes at√¥micas
- SEMPRE usar √≠ndices para queries frequentes

#### Timestamps
- SEMPRE incluir `createdAt` e `updatedAt`
- SEMPRE usar `defaultNow()` para timestamps

#### Soft Delete
- PREFERIR soft delete (isActive flag) ao inv√©s de DELETE
- Manter hist√≥rico de dados para auditoria

### 4. STRIPE E PAGAMENTOS

#### Checkout Flow
1. Cliente adiciona produtos ao carrinho (CartContext)
2. Aplica descontos no backend (ANTES do Stripe)
3. Cria orders com status PENDING
4. Cria Stripe Checkout Session
5. Redireciona para Stripe
6. Webhook processa pagamento aprovado
7. Atualiza orders para PAID
8. Cria userAssets (acesso do usu√°rio)

#### Webhook do Stripe
- SEMPRE validar assinatura do webhook
- SEMPRE verificar idempot√™ncia (processedWebhooks)
- SEMPRE validar payment_status === 'paid'
- SEMPRE validar metadata (userId, orderIds)
- SEMPRE usar transactions para opera√ß√µes cr√≠ticas

#### Descontos
- SEMPRE aplicar desconto NO BACKEND (nunca confiar no frontend)
- SEMPRE salvar pre√ßo COM DESCONTO na order
- SEMPRE enviar pre√ßo COM DESCONTO para Stripe
- Desconto √© aplicado em `createCheckoutSession()` via `applyDiscountToProducts()`

### 5. TYPESCRIPT

#### Types e Interfaces
- SEMPRE definir tipos expl√≠citos
- NUNCA usar `any` (usar `unknown` se necess√°rio)
- SEMPRE exportar interfaces de APIs
- SEMPRE usar tipos do Drizzle (inferidos do schema)

#### Nomenclatura
- Componentes: PascalCase (`ProductCard.tsx`)
- Fun√ß√µes: camelCase (`verifyUserAccess()`)
- Constantes: UPPER_SNAKE_CASE (`MAX_RETRIES`)
- Tipos: PascalCase (`interface AccessResult`)

### 6. REACT E NEXT.JS

#### Componentes
- SEMPRE usar 'use client' apenas quando necess√°rio
- PREFERIR Server Components quando poss√≠vel
- SEMPRE usar hooks do Next.js (useRouter, useParams, etc)
- SEMPRE validar loading/error states

#### Server Actions
- SEMPRE usar 'use server' em actions
- SEMPRE validar inputs
- SEMPRE tratar erros
- SEMPRE retornar objetos tipados

#### APIs vs Actions
- APIs: Opera√ß√µes RESTful (GET, POST, PUT, DELETE)
- Actions: Mutations de formul√°rios, opera√ß√µes complexas

### 7. ESTADO E CONTEXT

#### Context Pattern
```typescript
// 1. Criar interface do context
interface ContextType {
  // ...
}

// 2. Criar context com valor default
const Context = createContext<ContextType | null>(null);

// 3. Provider com useState/useEffect
export function Provider({ children }) {
  const [state, setState] = useState();
  // ...
  return <Context.Provider value={{...}}>{children}</Context.Provider>;
}

// 4. Hook customizado
export function useContext() {
  const context = useContext(Context);
  if (!context) throw new Error('useContext must be used within Provider');
  return context;
}
```

#### localStorage
- SEMPRE sincronizar com debounce (evitar writes excessivos)
- SEMPRE usar hidrata√ß√£o adequada (evitar hydration mismatch)
- SEMPRE versionar keys (`cart_items_v1`)

### 8. TRATAMENTO DE ERROS

#### Try-Catch
- SEMPRE envolver opera√ß√µes async em try-catch
- SEMPRE logar erros com contexto suficiente
- SEMPRE retornar mensagens user-friendly
- NUNCA expor stack traces para o usu√°rio

#### Logging
```typescript
// Formato padr√£o de logs:
console.log('[MODULE_NAME] Description', { context });
console.error('[MODULE_NAME_ERROR] Error description:', error);

// N√≠veis:
// [INFO] - Informa√ß√µes gerais
// [WARNING] - Avisos, mas n√£o cr√≠tico
// [ERROR] - Erros que impedem opera√ß√£o
// [ACCESS_LOG] - Auditoria de acessos
```

### 9. PERFORMANCE

#### Otimiza√ß√µes Obrigat√≥rias
- SEMPRE usar lazy loading para rotas pesadas
- SEMPRE otimizar imagens (Next Image)
- SEMPRE usar debounce em inputs de busca
- SEMPRE usar pagination em listas grandes
- SEMPRE usar √≠ndices no banco para queries frequentes

#### Caching
- SEMPRE usar cache do Next.js quando apropriado
- SEMPRE usar revalidation strategies
- NUNCA fazer requests desnecess√°rios

### 10. GIT E VERSIONAMENTO

#### Commits
```
Formato: <tipo>: <descri√ß√£o>

Tipos:
- feat: Nova funcionalidade
- fix: Corre√ß√£o de bug
- security: Corre√ß√£o de seguran√ßa
- refactor: Refatora√ß√£o
- perf: Melhoria de performance
- docs: Apenas documenta√ß√£o
- style: Formata√ß√£o (sem mudan√ßa de l√≥gica)
- test: Testes
- chore: Tarefas de manuten√ß√£o

Exemplos:
- feat: adicionar valida√ß√£o de acesso a m√≥dulos
- fix: corrigir bug de expiryDate em utils
- security: corrigir vulnerabilidade em API de orders
```

#### Branches
- `main` - Produ√ß√£o (sempre est√°vel)
- `develop` - Desenvolvimento (staging)
- `feature/nome-feature` - Features novas
- `fix/nome-bug` - Corre√ß√µes de bugs
- `security/nome-fix` - Corre√ß√µes de seguran√ßa

#### .gitignore
```
node_modules/
.next/
.env
.env.local
.DS_Store
*.log
.vercel
dist/
build/
*.md (EXCETO README.md)
```

---

## üîç CHECKLIST DE CODE REVIEW

Antes de commitar, verificar:

### Seguran√ßa
- [ ] APIs protegidas validam sess√£o JWT?
- [ ] Valida√ß√£o de acesso implementada?
- [ ] Inputs validados server-side?
- [ ] C√≥digos HTTP corretos?
- [ ] Erros n√£o exp√µem informa√ß√µes sens√≠veis?

### C√≥digo
- [ ] TypeScript sem erros?
- [ ] Sem console.logs desnecess√°rios?
- [ ] Sem c√≥digo comentado?
- [ ] Fun√ß√µes com menos de 50 linhas?
- [ ] Nomenclatura consistente?

### Performance
- [ ] Queries otimizadas?
- [ ] Sem N+1 queries?
- [ ] Debounce implementado onde necess√°rio?
- [ ] Imagens otimizadas?

### Documenta√ß√£o
- [ ] Coment√°rios em c√≥digo complexo?
- [ ] Tipos/interfaces documentadas?
- [ ] NENHUM arquivo .md desnecess√°rio criado?

---

## üìö REFER√äNCIAS R√ÅPIDAS

### Imports Comuns
```typescript
// Auth
import { requireAuth } from '@/lib/api-middleware';
import { verifyUserProductAccess } from '@/lib/access-control';
import { getSession } from '@/lib/auth';

// Database
import { db } from '@/lib/db';
import { users, products, orders, userAssets } from '@/drizzle/schema';
import { eq, and, or } from 'drizzle-orm';

// Next.js
import { NextRequest, NextResponse } from 'next/server';
import { useRouter, useParams } from 'next/navigation';

// Context
import { useAuth } from '@/contexts/AuthContext';
import { useCart } from '@/contexts/CartContext';
```

### Fun√ß√µes Cr√≠ticas
- `requireAuth(request)` - Validar autentica√ß√£o em API
- `verifyUserProductAccess(userId, productId)` - Validar acesso a produto
- `applyDiscountToProducts(products)` - Aplicar descontos
- `createCheckoutSession(userId, productIds)` - Criar sess√£o Stripe

---

## üö´ LEMBRE-SE

**NUNCA CRIAR ARQUIVOS .md AL√âM DO README.md**

Se precisar documentar algo:
1. Adicionar coment√°rios no c√≥digo
2. Atualizar o README.md
3. Criar interfaces/tipos bem documentados

**N√ÉO POLUIR O PROJETO COM DOCUMENTA√á√ÉO ESPALHADA**

---

√öltima atualiza√ß√£o: 2026-01-15
Vers√£o: 1.0.0
